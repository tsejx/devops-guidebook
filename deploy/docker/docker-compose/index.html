<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/devops-guidebook/umi.css" />
    <script>
      window.routerBase = "/devops-guidebook/";
    </script>
    <script>
      //! umi version: 3.2.9
    </script>
    <title>&#x591A;&#x5BB9;&#x5668;&#x90E8;&#x7F72;</title>
  
</head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/devops-icon.png&#x27;)" href="/devops-guidebook//">DevOps Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a href="/devops-guidebook//linux">Linux</a><a href="/devops-guidebook//server">服务器</a><a href="/devops-guidebook//data-base">数据库</a><a aria-current="page" class="active" href="/devops-guidebook//deploy">部署</a><a href="/devops-guidebook//code">代码管理</a><a href="/devops-guidebook//devops">DevOps</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/devops-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/devops-icon.png&#x27;)" href="/devops-guidebook//"></a><h1>DevOps Guidebook</h1><p>DevOps 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/devops-guidebook//linux">Linux</a></li><li><a href="/devops-guidebook//server">服务器</a></li><li><a href="/devops-guidebook//data-base">数据库</a></li><li><a aria-current="page" class="active" href="/devops-guidebook//deploy">部署</a></li><li><a href="/devops-guidebook//code">代码管理</a></li><li><a href="/devops-guidebook//devops">DevOps</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/devops-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a href="/devops-guidebook//deploy/theory">部署理论</a><ul><li><a href="/devops-guidebook//deploy/theory"><span>基本概述</span></a></li><li><a href="/devops-guidebook//deploy/theory/environment"><span>环境区分</span></a></li><li><a href="/devops-guidebook//deploy/theory/continuous-integration"><span>持续集成</span></a></li><li><a href="/devops-guidebook//deploy/theory/continuous-dilivery"><span>持续交付</span></a></li><li><a href="/devops-guidebook//deploy/theory/continuous-deployment"><span>持续部署</span></a></li><li><a href="/devops-guidebook//deploy/theory/blue-green-deployment"><span>蓝绿部署</span></a></li><li><a href="/devops-guidebook//deploy/theory/gray-release"><span>灰度部署</span></a></li><li><a href="/devops-guidebook//deploy/theory/rolling-update"><span>滚动部署</span></a></li></ul></li><li><a aria-current="page" class="active" href="/devops-guidebook//deploy/docker">Docker</a><ul><li><a href="/devops-guidebook//deploy/docker/overview"><span>基本概述</span></a></li><li><a href="/devops-guidebook//deploy/docker/image"><span>构建镜像</span></a></li><li><a href="/devops-guidebook//deploy/docker/docker-file"><span>配置脚本</span></a></li><li><a href="/devops-guidebook//deploy/docker/container"><span>操作容器</span></a></li><li><a href="/devops-guidebook//deploy/docker/storage-patterns-for-persistence"><span>持久存储模式</span></a></li><li><a href="/devops-guidebook//deploy/docker/network"><span>网络通信</span></a></li><li><a href="/devops-guidebook//deploy/docker/operations-and-monitor"><span>运维和监控</span></a></li><li><a aria-current="page" class="active" href="/devops-guidebook//deploy/docker/docker-compose"><span>多容器部署</span></a></li><li><a href="/devops-guidebook//deploy/docker/command"><span>常用命令</span></a></li><li><a href="/devops-guidebook//deploy/docker/extensions"><span>扩展资源</span></a></li><li><a href="/devops-guidebook//deploy/docker/mongodb"><span>部署 MongoDB</span></a></li></ul></li><li><a href="/devops-guidebook//deploy/github-actions">Github-actions</a><ul><li><a href="/devops-guidebook//deploy/github-actions"><span>Github Actions</span></a></li></ul></li><li><a href="/devops-guidebook//deploy/jenkins">Jenkins</a></li><li><a href="/devops-guidebook//deploy/rancher">Rancher</a></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"><li title="模版文件" data-depth="2" class=""><a href="/devops-guidebook//deploy/docker/docker-compose#模版文件"><span>模版文件</span></a></li><li title="顶层结构" data-depth="3" class=""><a href="/devops-guidebook//deploy/docker/docker-compose#顶层结构"><span>顶层结构</span></a></li><li title="image" data-depth="3" class=""><a href="/devops-guidebook//deploy/docker/docker-compose#image"><span>image</span></a></li><li title="build" data-depth="3" class=""><a href="/devops-guidebook//deploy/docker/docker-compose#build"><span>build</span></a></li><li title="depends_on" data-depth="3" class=""><a href="/devops-guidebook//deploy/docker/docker-compose#depends_on"><span>depends_on</span></a></li><li title="env_file" data-depth="3" class=""><a href="/devops-guidebook//deploy/docker/docker-compose#env_file"><span>env_file</span></a></li><li title="environment" data-depth="3" class=""><a href="/devops-guidebook//deploy/docker/docker-compose#environment"><span>environment</span></a></li><li title="secrets" data-depth="3" class=""><a href="/devops-guidebook//deploy/docker/docker-compose#secrets"><span>secrets</span></a></li><li title="expose" data-depth="3" class=""><a href="/devops-guidebook//deploy/docker/docker-compose#expose"><span>expose</span></a></li><li title="ports" data-depth="3" class=""><a href="/devops-guidebook//deploy/docker/docker-compose#ports"><span>ports</span></a></li><li title="network_mode" data-depth="3" class=""><a href="/devops-guidebook//deploy/docker/docker-compose#network_mode"><span>network_mode</span></a></li><li title="networks" data-depth="3" class=""><a href="/devops-guidebook//deploy/docker/docker-compose#networks"><span>networks</span></a></li><li title="volumes" data-depth="3" class=""><a href="/devops-guidebook//deploy/docker/docker-compose#volumes"><span>volumes</span></a></li><li title="labels" data-depth="3" class=""><a href="/devops-guidebook//deploy/docker/docker-compose#labels"><span>labels</span></a></li><li title="command" data-depth="3" class=""><a href="/devops-guidebook//deploy/docker/docker-compose#command"><span>command</span></a></li><li title="其他指令" data-depth="3" class=""><a href="/devops-guidebook//deploy/docker/docker-compose#其他指令"><span>其他指令</span></a></li><li title="命令行指令" data-depth="2" class=""><a href="/devops-guidebook//deploy/docker/docker-compose#命令行指令"><span>命令行指令</span></a></li><li title="up" data-depth="3" class=""><a href="/devops-guidebook//deploy/docker/docker-compose#up"><span>up</span></a></li><li title="build" data-depth="3" class=""><a href="/devops-guidebook//deploy/docker/docker-compose#build-1"><span>build</span></a></li><li title="exec" data-depth="3" class=""><a href="/devops-guidebook//deploy/docker/docker-compose#exec"><span>exec</span></a></li><li title="环境变量" data-depth="2" class=""><a href="/devops-guidebook//deploy/docker/docker-compose#环境变量"><span>环境变量</span></a></li><li title="把环境变量传递给容器" data-depth="3" class=""><a href="/devops-guidebook//deploy/docker/docker-compose#把环境变量传递给容器"><span>把环境变量传递给容器</span></a></li><li title="环境变量文件" data-depth="3" class=""><a href="/devops-guidebook//deploy/docker/docker-compose#环境变量文件"><span>环境变量文件</span></a></li><li title="配置不同场景下的环境变量" data-depth="3" class=""><a href="/devops-guidebook//deploy/docker/docker-compose#配置不同场景下的环境变量"><span>配置不同场景下的环境变量</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="多容器部署"><a aria-hidden="true" href="#多容器部署"><span class="icon icon-link"></span></a>多容器部署</h1><p>Docker Compose（多容器部署）是一个工具，这个工具可以通过一个 YML 文件定义多容器的 Docker 应用。通过一条命令就可以根据 YML 文件的定义去创建或者管理多个容器。</p><h2 id="模版文件"><a aria-hidden="true" href="#模版文件"><span class="icon icon-link"></span></a>模版文件</h2><p>模版文件是使用 Compose 的核型，设计到的指令关键字较多。但是大部分指令与 <code>docker run</code> 相关参数的含义都是类似的。</p><p>默认的模版文件名称为 <code>docker-compose.yml</code>，格式为 YAML 格式。</p><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="version: &#x27;3&#x27;

services:
  webapp:
    image: examples/web
    ports:
      - &#x27;80:80&#x27;
    volumes:
      - &#x27;/data&#x27;
" data-status="copy"></button><div class="token-line"><span class="token key atrule">version</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;3&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">webapp</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation">:</span><span class="token plain"> examples/web</span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">-</span><span class="token plain"> </span><span class="token string">&#x27;80:80&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">-</span><span class="token plain"> </span><span class="token string">&#x27;/data&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>⚠️ 注意每个服务都必须通过 <code>image</code> 指令指定镜像或 <code>build</code> 指令（需要 Dockerfile）等来自动构建生成镜像。</p><p>如果使用 <code>build</code> 指令，在 Dockerfile 中设置的选项（例如：<code>CMD</code>、<code>EXPOSE</code>、<code>VOLUME</code> 和 <code>ENV</code> 等）将会自动被获取，无需在 <code>docker-compose.yml</code> 中重复设置。</p><p>下面罗列了常用的模版文件指令配置项，详细的配置项参考 <a href="https://docs.docker.com/compose/compose-file/" target="_blank" rel="noopener noreferrer">📖 Compose file reference for Version 3<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，或者 <a href="https://yeasy.gitbooks.io/docker_practice/content/compose/compose_file.html" target="_blank" rel="noopener noreferrer">Docker 实战手册：模版文件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><h3 id="顶层结构"><a aria-hidden="true" href="#顶层结构"><span class="icon icon-link"></span></a>顶层结构</h3><p>顶层结构由 <code>version</code>、<code>services</code>、<code>networks</code> 和 <code>volumes</code> 等等标签构成。</p><p><strong>services</strong></p><ul><li>一个 service 代表一个 container，这个 container 可以从 dockerHub 中的镜像来创建，也可以使用本地 dockerfile build 出来的镜像来创建</li><li>service 的启动类似 docker run，可以给 service 指定 network 和 volume 的引用</li></ul><h3 id="image"><a aria-hidden="true" href="#image"><span class="icon icon-link"></span></a>image</h3><p>指定为镜像名称或镜像 ID。如果镜像在本地不存在，Compose 将会尝试拉取这个镜像。</p><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="image: ubuntu
image: orchardup/postgresql
image: a4bc65fd
" data-status="copy"></button><div class="token-line"><span class="token key atrule">image</span><span class="token punctuation">:</span><span class="token plain"> ubuntu</span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">image</span><span class="token punctuation">:</span><span class="token plain"> orchardup/postgresql</span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">image</span><span class="token punctuation">:</span><span class="token plain"> a4bc65fd</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="build"><a aria-hidden="true" href="#build"><span class="icon icon-link"></span></a>build</h3><p>基于 Dockerfile，指定 Dockerfile 所在路径，Compose 会利用它自动构建镜像，然后启动服务容器。</p><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="# 绝对路径
build: /path/build

# 相对路径
build: ./dir

# 设定上下文和目录，以此目录指定 Dockerfile
build:
  context: ../
  dockerfile: path/dockerfile

# 给 Dockerfile 构建的镜像命名
build: ./dir
images: nginx:latest

# 构建过程中指定环境变量，构建成功后取消
# 与 EVN 不同 ARG 允许空值
build:
  context: ./dir
  dockerfile: Dockerfile-alternate
  args:
    buildno: 1
    password: secret
  caceh_form:
    - alpine:latest
    - corp/web_app:3.14
" data-status="copy"></button><div class="token-line"><span class="token comment"># 绝对路径</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">build</span><span class="token punctuation">:</span><span class="token plain"> /path/build</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 相对路径</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">build</span><span class="token punctuation">:</span><span class="token plain"> ./dir</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 设定上下文和目录，以此目录指定 Dockerfile</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">build</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">context</span><span class="token punctuation">:</span><span class="token plain"> ../</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">dockerfile</span><span class="token punctuation">:</span><span class="token plain"> path/dockerfile</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 给 Dockerfile 构建的镜像命名</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">build</span><span class="token punctuation">:</span><span class="token plain"> ./dir</span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">images</span><span class="token punctuation">:</span><span class="token plain"> nginx</span><span class="token punctuation">:</span><span class="token plain">latest</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 构建过程中指定环境变量，构建成功后取消</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 与 EVN 不同 ARG 允许空值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">build</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">context</span><span class="token punctuation">:</span><span class="token plain"> ./dir</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">dockerfile</span><span class="token punctuation">:</span><span class="token plain"> Dockerfile</span><span class="token punctuation">-</span><span class="token plain">alternate</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">args</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">buildno</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">password</span><span class="token punctuation">:</span><span class="token plain"> secret</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">caceh_form</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">-</span><span class="token plain"> alpine</span><span class="token punctuation">:</span><span class="token plain">latest</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">-</span><span class="token plain"> corp/web_app</span><span class="token punctuation">:</span><span class="token number">3.14</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><code>context</code>：路径</li><li><code>dockerfile</code>：需要替换默认 <code>docker-compose</code> 的文件名</li><li><code>args</code>：为构建（build）过程的环境变量，用于替换 Dockerfile 里定义的 ARG 参数，容器中不可用</li><li><code>cache_from</code>：指定构建镜像的缓存</li></ul><h3 id="depends_on"><a aria-hidden="true" href="#depends_on"><span class="icon icon-link"></span></a>depends_on</h3><p>解决容器的依赖、启动先后问题。</p><p>🌰 <strong>示例：</strong></p><p>以下例子会先启动 <code>redis</code> 和 <code>db</code> 再启动 <code>web</code></p><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="version: &#x27;3&#x27;

services:
  web:
    build: .
    depends_on:
      - db
      - redis

  redis:
    image: redis

  db:
    image: postgres
" data-status="copy"></button><div class="token-line"><span class="token key atrule">version</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;3&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">web</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">build</span><span class="token punctuation">:</span><span class="token plain"> .</span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">depends_on</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">-</span><span class="token plain"> db</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">-</span><span class="token plain"> redis</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">redis</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation">:</span><span class="token plain"> redis</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">db</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation">:</span><span class="token plain"> postgres</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><blockquote><p>⚠️ <strong>注意：</strong> <code>web</code> 服务不会等待 数据库（例如 <code>redis</code> 和 <code>db</code>）完全启动之后才启动，也就是 <code>depends_on</code> 只是决定开启顺序，容器内数据库是否已经初始化启动完毕后 Web 服务才能连接上，这里是很坑的一个地方。</p></blockquote><p><strong>解决方法</strong></p><p>可能官方也知道这里很坑，官方文档中给出了解决方案（<a href="https://docs.docker.com/compose/startup-order/" target="_blank" rel="noopener noreferrer">startup-order<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）。</p><h3 id="env_file"><a aria-hidden="true" href="#env_file"><span class="icon icon-link"></span></a>env_file</h3><p>从文件中获取环境变量，可以为单独的文件路径或列表。</p><p>如果通过 <code>docker-compose -f FILE</code> 方式来指定 Compose 模板文件，则 <code>env_file</code> 中变量的路径会基于模板文件路径。</p><p>如果有变量名称与 <code>environment</code> 指令冲突，则按照惯例，以后者为准。</p><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="# 若与 environment 指令冲突，以后者为准
env_file: .env

# 可设置多个
# 此变量不对 build 构建过程生效
env_file:
  - ./common.env
  - ./apps/web.env
  - /opt/secrets.env
" data-status="copy"></button><div class="token-line"><span class="token comment"># 若与 environment 指令冲突，以后者为准</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">env_file</span><span class="token punctuation">:</span><span class="token plain"> .env</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 可设置多个</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 此变量不对 build 构建过程生效</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">env_file</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> ./common.env</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> ./apps/web.env</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> /opt/secrets.env</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>环境变量文件中每一行必须符合格式，支持 # 开头的注释行。</p><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="# common.env: Set development environment
PROG_ENV=development
" data-status="copy"></button><div class="token-line"><span class="token comment"># common.env: Set development environment</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">PROG_ENV=development</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="environment"><a aria-hidden="true" href="#environment"><span class="icon icon-link"></span></a>environment</h3><p>设置环境变量。你可以使用<strong>数组</strong>或<strong>字典</strong>两种格式。</p><p>只给定名称的变量会自动获取运行 Compose 主机上对应变量的值，可以用来防止泄露不必要的数据。</p><p>启动后的容器会包含这些变量设置。</p><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="environment:
  RACK_ENV: development
  SESSION_SECRET:

environment:
  - RACK_ENV=development
  - SESSION_SECRET
" data-status="copy"></button><div class="token-line"><span class="token key atrule">environment</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">RACK_ENV</span><span class="token punctuation">:</span><span class="token plain"> development</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">SESSION_SECRET</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">environment</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> RACK_ENV=development</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> SESSION_SECRET</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>如果变量名称或者值中用到 <code>true|false</code>，<code>yes|no</code> 等表达 <strong>布尔</strong> 含义的词汇，最好放到引号里，避免 YAML 自动解析某些内容为对应的布尔语义。这些特定词汇，包括</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="y|Y|yes|Yes|YES|n|N|no|No|NO|true|True|TRUE|false|False|FALSE|on|On|ON|off|Off|OFF
" data-status="copy"></button><div class="token-line"><span class="token plain">y|Y|yes|Yes|YES|n|N|no|No|NO|true|True|TRUE|false|False|FALSE|on|On|ON|off|Off|OFF</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="secrets"><a aria-hidden="true" href="#secrets"><span class="icon icon-link"></span></a>secrets</h3><p>存储敏感数据，例如 mysql 服务密码。</p><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="version: &#x27;3.1&#x27;
services:

mysql:
  image: mysql
  environment:
    MYSQL_ROOT_PASSWORD_FILE: /run/secrets/db_root_password
  secrets:
    - db_root_password
    - my_other_secret

secrets:
  my_secret:
    file: ./my_secret.txt
  my_other_secret:
    external: true
" data-status="copy"></button><div class="token-line"><span class="token key atrule">version</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;3.1&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">mysql</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">image</span><span class="token punctuation">:</span><span class="token plain"> mysql</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">environment</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">MYSQL_ROOT_PASSWORD_FILE</span><span class="token punctuation">:</span><span class="token plain"> /run/secrets/db_root_password</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">secrets</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">-</span><span class="token plain"> db_root_password</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">-</span><span class="token plain"> my_other_secret</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">secrets</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">my_secret</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">file</span><span class="token punctuation">:</span><span class="token plain"> ./my_secret.txt</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">my_other_secret</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">external</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="expose"><a aria-hidden="true" href="#expose"><span class="icon icon-link"></span></a>expose</h3><p>暴露端口，但不映射到宿主机，只被连接的服务访问。</p><p>仅可以指定内部端口为参数</p><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="expose:
  - &#x27;3000&#x27;
  - &#x27;8000&#x27;
" data-status="copy"></button><div class="token-line"><span class="token key atrule">expose</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> </span><span class="token string">&#x27;3000&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> </span><span class="token string">&#x27;8000&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="ports"><a aria-hidden="true" href="#ports"><span class="icon icon-link"></span></a>ports</h3><p>暴露端口信息。</p><p>使用 <code>宿主端口：容器端口</code> (<code>HOST:CONTAINER</code>) 格式，或者仅仅指定容器的端口（宿主将会随机选择端口）都可以。</p><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="ports:
  - &#x27;3000&#x27;
  - &#x27;8000:8000&#x27;
  - &#x27;49100:22&#x27;
  - &#x27;127.0.0.1:8001:8001&#x27;
" data-status="copy"></button><div class="token-line"><span class="token key atrule">ports</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> </span><span class="token string">&#x27;3000&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> </span><span class="token string">&#x27;8000:8000&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> </span><span class="token string">&#x27;49100:22&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> </span><span class="token string">&#x27;127.0.0.1:8001:8001&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>⚠️ <strong>注意</strong>：当使用 <code>HOST:CONTAINER</code> 格式来映射端口时，如果你使用的容器端口小于 60 并且没放到引号里，可能会得到错误结果，因为 YAML 会自动解析 <code>xx:yy</code> 这种数字格式为 60 进制。为避免出现这种问题，建议数字串都采用引号包括起来的字符串格式。</p><h3 id="network_mode"><a aria-hidden="true" href="#network_mode"><span class="icon icon-link"></span></a>network_mode</h3><p>设置网络模式。使用和 <code>docker run</code> 的 <code>--network</code> 参数一样的值。</p><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="network_mode: &quot;bridge&quot;
network_mode: &quot;host&quot;
network_mode: &quot;none&quot;
network_mode: &quot;service:[service name]&quot;
network_mode: &quot;container:[container name/id]&quot;
" data-status="copy"></button><div class="token-line"><span class="token key atrule">network_mode</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;bridge&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">network_mode</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;host&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">network_mode</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;none&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">network_mode</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;service:[service name]&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">network_mode</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;container:[container name/id]&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="networks"><a aria-hidden="true" href="#networks"><span class="icon icon-link"></span></a>networks</h3><p>配置容器连接的网络。相当于执行 <code>docker network create xxx</code>。</p><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="version: &#x27;3&#x27;
services:
  some-service:
    networks:
      - some-network
      - other-network

networks:
  some-network:
  other-network:
" data-status="copy"></button><div class="token-line"><span class="token key atrule">version</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;3&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">some-service</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">networks</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">-</span><span class="token plain"> some</span><span class="token punctuation">-</span><span class="token plain">network</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">-</span><span class="token plain"> other</span><span class="token punctuation">-</span><span class="token plain">network</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">networks</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">some-network</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">other-network</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="volumes"><a aria-hidden="true" href="#volumes"><span class="icon icon-link"></span></a>volumes</h3><p>数据卷所挂载路径设置。可以设置为宿主机路径（<code>HOST:CONTAINER</code>）或者数据卷名称（<code>VOLUME:CONTAINER</code>），并且可以设置访问模式 （<code>HOST:CONTAINER:ro</code>）。</p><p>相当于执行 <code>docker volume create xxx</code>。</p><p>该指令中路径支持相对路径。</p><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="volumes:
  # 只指定一个路径，Docker 会自动在创建一个数据卷（这个路径是容器内部的）
  - /var/lib/mysql

  # 使用绝对路径挂在数据卷
  - /opt/data:/var/lib/mysql

  # 以 Compose 配置文件为中心的相对路径作为数据卷挂载到容器。
  - ./cache:/tmp/cache

  # 使用用户的相对路径（~/ 表示目录是 /home/&lt;用户目录&gt;/ 或者 /root/）
  - ~/configs:/etc/configs/:ro

  # 已经存在的命令的数据卷
  - datavolume:/var/lib/mysql
" data-status="copy"></button><div class="token-line"><span class="token key atrule">volumes</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 只指定一个路径，Docker 会自动在创建一个数据卷（这个路径是容器内部的）</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> /var/lib/mysql</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 使用绝对路径挂在数据卷</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> /opt/data</span><span class="token punctuation">:</span><span class="token plain">/var/lib/mysql</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 以 Compose 配置文件为中心的相对路径作为数据卷挂载到容器。</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> ./cache</span><span class="token punctuation">:</span><span class="token plain">/tmp/cache</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 使用用户的相对路径（~/ 表示目录是 /home/&lt;用户目录&gt;/ 或者 /root/）</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> ~/configs</span><span class="token punctuation">:</span><span class="token plain">/etc/configs/</span><span class="token punctuation">:</span><span class="token plain">ro</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 已经存在的命令的数据卷</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> datavolume</span><span class="token punctuation">:</span><span class="token plain">/var/lib/mysql</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>如果路径为数据卷名称，必须在文件中配置数据卷。</p><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="version: &#x27;3&#x27;

services:
  my_src:
    image: mysql:8.0
    volumes:
      - mysql_data:/var/lib/mysql

volumes:
  mysql_data:
" data-status="copy"></button><div class="token-line"><span class="token key atrule">version</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;3&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">my_src</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation">:</span><span class="token plain"> mysql</span><span class="token punctuation">:</span><span class="token number">8.0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">-</span><span class="token plain"> mysql_data</span><span class="token punctuation">:</span><span class="token plain">/var/lib/mysql</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">volumes</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">mysql_data</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="labels"><a aria-hidden="true" href="#labels"><span class="icon icon-link"></span></a>labels</h3><p>为容器添加 Docker 元数据（metadata）信息。例如可以为容器添加辅助说明信息。</p><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="labels:
  com.startupteam.description: &#x27;webapp for a startup team&#x27;
  com.startupteam.department: &#x27;devops department&#x27;
  com.startupteam.release: &#x27;rc3 for v1.0&#x27;
" data-status="copy"></button><div class="token-line"><span class="token key atrule">labels</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">com.startupteam.description</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;webapp for a startup team&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">com.startupteam.department</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;devops department&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">com.startupteam.release</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;rc3 for v1.0&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="command"><a aria-hidden="true" href="#command"><span class="icon icon-link"></span></a>command</h3><p>覆盖容器启动后默认执行的命令</p><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="command: bundle exec thin -p 3000

# 或 写成 exec 形式
command: [bundle exec thin -p, 3000]
" data-status="copy"></button><div class="token-line"><span class="token key atrule">command</span><span class="token punctuation">:</span><span class="token plain"> bundle exec thin </span><span class="token punctuation">-</span><span class="token plain">p 3000</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 或 写成 exec 形式</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">command</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">bundle exec thin </span><span class="token punctuation">-</span><span class="token plain">p</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">3000</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="其他指令"><a aria-hidden="true" href="#其他指令"><span class="icon icon-link"></span></a>其他指令</h3><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="# 指定容器名称，默认使用 `项目名称_服务名称_序号` 这样的格式
container_name: docker-container

# 指定设备映射关系
devices:
  - &quot;/dev/ttyUSB0:/dev/ttyUSB0&quot;

# 自定义 DNS 服务器，可以是一个值，也可以是一个列表
dns: 8.8.8.8
dns:
  - 8.8.8.8
  - 9.9.9.9

# 配置 DNS 搜索域，可以是一个值，也可以是一个列表
dns_search: example.com
dns_search:
  - dc1.example.com
  - dc2.example.com

# 配置日志选项
logging:
  driver: &quot;syslog&quot;
  options:
    syslog-address: &quot;tcp://192.168.0.42:123&quot;

# 指定服务容器启动后执行的入口文件
entrypoint: /code/entrypoint.sh

# 指定容器中运行应用的用户名
user: postgresql

# 指定容器中工作目录
working_dir: /code

# 挂在临时目录到容器内部，与 run 参数效果一致
tmpfs: /run
tmpfs:
  - /run
  - /tmp

# 连接到其他服务器中的容器
links:
  - db
  - db:mysql
  - redis
" data-status="copy"></button><div class="token-line"><span class="token comment"># 指定容器名称，默认使用 `项目名称_服务名称_序号` 这样的格式</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">container_name</span><span class="token punctuation">:</span><span class="token plain"> docker</span><span class="token punctuation">-</span><span class="token plain">container</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 指定设备映射关系</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">devices</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> </span><span class="token string">&quot;/dev/ttyUSB0:/dev/ttyUSB0&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 自定义 DNS 服务器，可以是一个值，也可以是一个列表</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">dns</span><span class="token punctuation">:</span><span class="token plain"> 8.8.8.8</span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">dns</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> 8.8.8.8</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> 9.9.9.9</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 配置 DNS 搜索域，可以是一个值，也可以是一个列表</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">dns_search</span><span class="token punctuation">:</span><span class="token plain"> example.com</span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">dns_search</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> dc1.example.com</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> dc2.example.com</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 配置日志选项</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">logging</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">driver</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;syslog&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">options</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">syslog-address</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;tcp://192.168.0.42:123&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 指定服务容器启动后执行的入口文件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">entrypoint</span><span class="token punctuation">:</span><span class="token plain"> /code/entrypoint.sh</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 指定容器中运行应用的用户名</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">user</span><span class="token punctuation">:</span><span class="token plain"> postgresql</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 指定容器中工作目录</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">working_dir</span><span class="token punctuation">:</span><span class="token plain"> /code</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 挂在临时目录到容器内部，与 run 参数效果一致</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">tmpfs</span><span class="token punctuation">:</span><span class="token plain"> /run</span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">tmpfs</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> /run</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> /tmp</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 连接到其他服务器中的容器</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">links</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> db</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> db</span><span class="token punctuation">:</span><span class="token plain">mysql</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">-</span><span class="token plain"> redis</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="命令行指令"><a aria-hidden="true" href="#命令行指令"><span class="icon icon-link"></span></a>命令行指令</h2><p>docker-compose up 自动完成包括构建镜像、（重新）创建服务、启动服务，并关联服务相关容器的一系列操作 docker-compose build</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="# -f  指定使用的 Compose 模板文件，默认为 docker-compose.yml，可以多次指定。
docker-compose -f docker-compose.yml up -d

# 启动所有容器，-d 将会在后台启动并运行所有的容器
docker-compose up -d

# 查看服务容器的输出
docker-compose logs

# 列出项目中目前的所有容器
docker-compose ps

# 构建（重新构建）项目中的服务容器
# 服务容器一旦构建后，将会带上一个标记名，例如对于 web 项目中的一个 db 容器，可能是 web_db
# 可以随时在项目目录下运行 docker-compose build 来重新构建服务
docker-compose build

# 拉取服务依赖的镜像
docker-compose pull

# 重启项目中的服务
# 如果对 docker-compose.yml 配置进行更改，则运行此命令后不会反映这些更改
docker-compose restart

# 删除所有（停止状态的）服务容器
# 推荐先执行 docker-compose stop 命令来停止容器
# 默认情况下，不删除附加到容器的匿名卷
# 任何不在卷中的数据都将丢失
docker-compose rm

# 在指定服务上执行一个命令。
docker-compose run ubuntu ping docker.com

# 设置指定服务运行的容器个数
# 通过 service=num 的参数来设置数量
docker-compose scale web=3 db=2

# 启动已经存在的服务容器。
docker-compose start

# 停止已经处于运行状态的容器，但不删除它
# 通过 docker-compose start 可以再次启动这些容器。
docker-compose stop
" data-status="copy"></button><div class="token-line"><span class="token comment"># -f  指定使用的 Compose 模板文件，默认为 docker-compose.yml，可以多次指定。</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">docker-compose -f docker-compose.yml up -d</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 启动所有容器，-d 将会在后台启动并运行所有的容器</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">docker-compose up -d</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 查看服务容器的输出</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">docker-compose logs</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 列出项目中目前的所有容器</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">docker-compose </span><span class="token function">ps</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 构建（重新构建）项目中的服务容器</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 服务容器一旦构建后，将会带上一个标记名，例如对于 web 项目中的一个 db 容器，可能是 web_db</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 可以随时在项目目录下运行 docker-compose build 来重新构建服务</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">docker-compose build</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 拉取服务依赖的镜像</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">docker-compose pull</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 重启项目中的服务</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 如果对 docker-compose.yml 配置进行更改，则运行此命令后不会反映这些更改</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">docker-compose restart</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 删除所有（停止状态的）服务容器</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 推荐先执行 docker-compose stop 命令来停止容器</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 默认情况下，不删除附加到容器的匿名卷</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 任何不在卷中的数据都将丢失</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">docker-compose </span><span class="token function">rm</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 在指定服务上执行一个命令。</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">docker-compose run ubuntu </span><span class="token function">ping</span><span class="token plain"> docker.com</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 设置指定服务运行的容器个数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 通过 service=num 的参数来设置数量</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">docker-compose scale </span><span class="token assign-left variable">web</span><span class="token operator">=</span><span class="token number">3</span><span class="token plain"> </span><span class="token assign-left variable">db</span><span class="token operator">=</span><span class="token number">2</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 启动已经存在的服务容器。</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">docker-compose start</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 停止已经处于运行状态的容器，但不删除它</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 通过 docker-compose start 可以再次启动这些容器。</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">docker-compose stop</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="up"><a aria-hidden="true" href="#up"><span class="icon icon-link"></span></a>up</h3><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="docker-compose up [options] [--scale SERVICE=NUM...] [SERVICE...]
" data-status="copy"></button><div class="token-line"><span class="token plain">docker-compose up </span><span class="token punctuation">[</span><span class="token plain">options</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">--scale </span><span class="token assign-left variable">SERVICE</span><span class="token operator">=</span><span class="token plain">NUM</span><span class="token punctuation">..</span><span class="token plain">.</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">SERVICE</span><span class="token punctuation">..</span><span class="token plain">.</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><code>-d</code>：在后台运行服务容器</li><li><code>-no-color</code>：不使用颜色来区分不同的服务的控制输出</li><li><code>-no-deps</code>：不启动服务所链接的容器</li><li><code>-force-recreate</code>：强制重新创建容器，不能与 <code>–no-recreate</code> 同时使用</li><li><code>-no-recreate</code>：如果容器已经存在，则不重新创建，不能与 <code>–force-recreate</code> 同时使用</li><li><code>-no-build</code>：不自动构建缺失的服务镜像</li><li><code>-build</code>：在启动容器前构建服务镜像</li><li><code>-abort-on-container-exit</code>：停止所有容器，如果任何一个容器被停止，不能与 <code>-d</code> 同时使用</li><li><code>-t</code>、<code>-timeout TIME</code>：停止容器时候的超时（默认为 10 秒）</li><li><code>-remove-orphans</code>：删除服务中没有在 compose 文件中定义的容器</li><li><code>-scale SERVICE=NUM</code>：设置服务运行容器的个数，将覆盖在 compose 中通过 scale 指定的参数</li></ul><p>当 <code>docker-compose up</code> 命令汇总每个容器的输出（本质上是 <code>docker-compose logs -f</code>）。当命令退出时，所有容器都将停止。运行 <code>docker-compose up -d</code> 将在后台启动容器并使它们继续运行。</p><h3 id="build-1"><a aria-hidden="true" href="#build-1"><span class="icon icon-link"></span></a>build</h3><p>实际项目中，不可能只单单依赖于一个服务，例如一个常见的 Web 项目可能依赖于: 静态文件服务器，应用服务器，Mysql 数据库等。我们可以通过分别启动单个镜像，并把镜像绑定到本地对应端口的形式进行部署，达到容器可通信的目的。但是为了更方便的管理多容器的情况，官方提供了 docker-compose 的方式。docker-compose 是 Docker 的一种编排服务，是一个用于在 Docker 上定义并运行复杂应用的工具，可以让用户在集群中部署分布式应用。</p><p>compose 中有两个重要的概念：</p><ul><li>服务（service）：一个应用的容器，实际上可以包括若干运行相同镜像的容器示例</li><li>项目（project）：由一组关联的应用容器组成的一个完整业务单元，在 <code>docker-compose.yml</code> 文件中定义</li></ul><p>一个项目可以由多个服务（容器）关联而成，compose 面向项目进行管理，通过自命令对项目中的一组容器进行便捷的生命周期管理。</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="docker-compose build [options] [--build-arg key=val...] [SERVICE]
" data-status="copy"></button><div class="token-line"><span class="token plain">docker-compose build </span><span class="token punctuation">[</span><span class="token plain">options</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">--build-arg </span><span class="token assign-left variable">key</span><span class="token operator">=</span><span class="token plain">val</span><span class="token punctuation">..</span><span class="token plain">.</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">SERVICE</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>选项包括：</p><ul><li><code>--compress</code>：通过 gzip 压缩构建上下环境</li><li><code>--force-rm</code>：删除构建过程中的临时容器</li><li><code>--no-cache</code>：构建镜像过程中不使用缓存</li><li><code>--pull</code>：始终尝试通过拉取操作来获取更新版本的镜像</li><li><code>-m, --memory</code>： MEM 为构建的容器设置内存大小</li><li><code>--build-arg key=val</code>：为服务设置 build-time 变量</li><li><code>--parallel</code>：并行构建映像</li></ul><h3 id="exec"><a aria-hidden="true" href="#exec"><span class="icon icon-link"></span></a>exec</h3><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="docker-compose exec [options] SERVICE COMMAND [ARGS...]
" data-status="copy"></button><div class="token-line"><span class="token plain">docker-compose </span><span class="token builtin class-name">exec</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">options</span><span class="token punctuation">]</span><span class="token plain"> SERVICE COMMAND </span><span class="token punctuation">[</span><span class="token plain">ARGS</span><span class="token punctuation">..</span><span class="token plain">.</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>等同于 <code>docker exec</code>，使用此子命令，可以在服务中运行任意命令。默认情况下，命令是分配给 TTY 的，因此您可以使用命令 <code>docker-compose exec web sh</code> 来获得交互式提示。</p><ul><li><code>-d</code>：分离模式，后台运行命令</li><li><code>--privileged</code>：获取特权</li><li><code>-u</code>：指定运行的用户</li><li><code>-T</code>：禁用分配 TTY</li><li><code>--index=index</code>：当一个服务拥有多个容器时，可通过该参数登陆到该服务下的任何服务，例如： <code>docker-compose exec –index=1 web /bin/bash</code>，Web 服务中包含多个容器</li><li><code>-e, --env KEY=VAL</code>：设置环境变量</li><li><code>-w, --workdir</code>：指向此命令的 workdir 目录的路径</li></ul><h2 id="环境变量"><a aria-hidden="true" href="#环境变量"><span class="icon icon-link"></span></a>环境变量</h2><p>在 compose file 中引用环境变量</p><p>参考：<a href="https://www.cnblogs.com/sparkdev/p/9826520.html" target="_blank" rel="noopener noreferrer">Docker Compose 引用环境变量<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="version: &#x27;3&#x27;

services:
  web:
    image: ${IMAGETAG}
    ports:
      - &#x27;5000:5000&#x27;
  redis:
    image: &#x27;redis:alpine&#x27;
" data-status="copy"></button><div class="token-line"><span class="token key atrule">version</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;3&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">web</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation">:</span><span class="token plain"> $</span><span class="token punctuation">{</span><span class="token plain">IMAGETAG</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">-</span><span class="token plain"> </span><span class="token string">&#x27;5000:5000&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">redis</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;redis:alpine&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>通过环境变量 <code>$<!-- -->{<!-- -->IMAGETAG<!-- -->}</code> 指定了 web 的镜像，下面通过 <code>export</code> 的方式来 compose 配置文件中的环境变量传值：</p><p>⚠️ 注意：如果对应的环境变量没有被设置，那么 compose 就会把它替换为一个空字符串</p><p>这种情况，可以为变量设置默认值：</p><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="version: &#x27;3&#x27;

services:
  web:
    image: ${IMAGETAG: -defaultwebimage}
    ports:
      - &quot;5000:5000&quot;
  redis:
    image: &quot;redis:alpine&quot;
" data-status="copy"></button><div class="token-line"><span class="token key atrule">version</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;3&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">web</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation">:</span><span class="token plain"> $</span><span class="token punctuation">{</span><span class="token key atrule">IMAGETAG</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">-</span><span class="token plain">defaultwebimage</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">-</span><span class="token plain"> </span><span class="token string">&quot;5000:5000&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">redis</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;redis:alpine&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p><code>defaultwebimage</code> 是默认值。</p><h3 id="把环境变量传递给容器"><a aria-hidden="true" href="#把环境变量传递给容器"><span class="icon icon-link"></span></a>把环境变量传递给容器</h3><p>compose file 中为容器设置环境变量：</p><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="web:
  environment:
    DEBUG: 1
" data-status="copy"></button><div class="token-line"><span class="token key atrule">web</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">environment</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">DEBUG</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>compose file 中的 environment 节点用来为容器设置环境变量，上面的写法等同于：</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="$ docker run -e DEBUG=1
" data-status="copy"></button><div class="token-line"><span class="token plain">$ docker run -e </span><span class="token assign-left variable">DEBUG</span><span class="token operator">=</span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>要把当前 shell 环境变量的值传递给容器的环境变量也很简单，去掉上面代码中的赋值部分即可：</p><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="web:
  environment:
    DEBUG:
" data-status="copy"></button><div class="token-line"><span class="token key atrule">web</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">environment</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">DEBUG</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>尝试导出环境变量 <code>DEBUG</code> 的情况：</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="$ export DEBUG=1
" data-status="copy"></button><div class="token-line"><span class="token plain">$ </span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable">DEBUG</span><span class="token operator">=</span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="环境变量文件"><a aria-hidden="true" href="#环境变量文件"><span class="icon icon-link"></span></a>环境变量文件</h3><p>当我们在 <code>docker-compose.yml</code> 文件中引用了大量的环境变量时，对每个环境变量都设置默认值将是繁琐的，并且也会影响 <code>docker-compose.yml</code> 简洁程度。此时我们可以通过 .<code>env</code> 文件来为 <code>docker-compose.yml</code> 文件引用的所有环境变量设置默认值。</p><p>修改 <code>docker-compose.yml</code> 文件的内容如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="version: &#x27;3&#x27;
services:
  web:
    image: ${IMAGETAG}
    environment:
      APPNAME:
      AUTHOR:
      VERSION:
    ports:
      - &#x27;5000:5000&#x27;
  redis:
    image: &#x27;redis:alpine&#x27;
" data-status="copy"></button><div class="token-line"><span class="token key atrule">version</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;3&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">web</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation">:</span><span class="token plain"> $</span><span class="token punctuation">{</span><span class="token plain">IMAGETAG</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">environment</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token key atrule">APPNAME</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token key atrule">AUTHOR</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token key atrule">VERSION</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">-</span><span class="token plain"> </span><span class="token string">&#x27;5000:5000&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">redis</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;redis:alpine&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>然后在相同的目录下创建 <code>.env</code> 文件，编辑其内容如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="# define env var default value.
IMAGETAG=defaultwebimage
APPNAME=default app name
AUTHOR=default author name
VERSION=default version is 1.0
" data-status="copy"></button><div class="token-line"><span class="token plain"># define env var default value.</span></div><div class="token-line"><span class="token plain">IMAGETAG=defaultwebimage</span></div><div class="token-line"><span class="token plain">APPNAME=default app name</span></div><div class="token-line"><span class="token plain">AUTHOR=default author name</span></div><div class="token-line"><span class="token plain">VERSION=default version is 1.0</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="配置不同场景下的环境变量"><a aria-hidden="true" href="#配置不同场景下的环境变量"><span class="icon icon-link"></span></a>配置不同场景下的环境变量</h3><p>从前面的部分中我们可以看到，docker compose 提供了足够的灵活性来让我们设置 docker-compose.yml 文件中引用的环境变量，它们的优先级如下：</p><ol><li>Compose file</li><li>Shell environment variables</li><li>Environment file</li><li>Dockerfile</li><li>Variable is not defined</li></ol><ul><li>首先，在 docker-compose.yml 文件中直接设置的值优先级是最高的。</li><li>然后是在当前 shell 中 export 的环境变量值。</li><li>接下来是在环境变量文件中定义的值。</li><li>再接下来是在 Dockerfile 中定义的值。</li><li>最后还没有找到相关的环境变量就认为该环境变量没有被定义。</li></ul><p>根据上面的优先级定义，我们可以把不同场景下的环境变量定义在不同的 shell 脚本中并导出，然后在执行 <code>docker-compose</code> 命令前先执行 <code>source</code> 命令把 shell 脚本中定义的环境变量导出到当前的 shell 中。通过这样的方式可以减少维护环境变量的地方，下面的例子中我们分别在 <code>docker-compose.yml</code> 文件所在的目录创建 <code>test.sh</code> 和 <code>prod.sh</code>。</p><p><code>test.sh</code> 的内容如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="#!/bin/bash
# define env var default value.
export IMAGETAG=web:v1
export APPNAME=HelloWorld
export AUTHOR=Nick Li
export VERSION=1.0
" data-status="copy"></button><div class="token-line"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># define env var default value.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable">IMAGETAG</span><span class="token operator">=</span><span class="token plain">web:v1</span></div><div class="token-line"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable">APPNAME</span><span class="token operator">=</span><span class="token plain">HelloWorld</span></div><div class="token-line"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable">AUTHOR</span><span class="token operator">=</span><span class="token plain">Nick Li</span></div><div class="token-line"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable">VERSION</span><span class="token operator">=</span><span class="token number">1.0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p><code>prod.sh</code> 的内容如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="#!/bin/bash
# define env var default value.
export IMAGETAG=webpord:v1
export APPNAME=HelloWorldProd
export AUTHOR=Nick Li
export VERSION=1.0LTS
" data-status="copy"></button><div class="token-line"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># define env var default value.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable">IMAGETAG</span><span class="token operator">=</span><span class="token plain">webpord:v1</span></div><div class="token-line"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable">APPNAME</span><span class="token operator">=</span><span class="token plain">HelloWorldProd</span></div><div class="token-line"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable">AUTHOR</span><span class="token operator">=</span><span class="token plain">Nick Li</span></div><div class="token-line"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable">VERSION</span><span class="token operator">=</span><span class="token number">1</span><span class="token plain">.0LTS</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>在测试环境下，执行下面的命令：</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="$ source test.sh

$ docker-compose config
" data-status="copy"></button><div class="token-line"><span class="token plain">$ </span><span class="token builtin class-name">source</span><span class="token plain"> test.sh</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ docker-compose config</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>此时 docker-compose.yml 中的环境变量应用的都是生产环境相关的设置。</p><hr/><p><strong>参考资料：</strong></p><ul><li><a href="https://docs.docker.com/compose/compose-file/" target="_blank" rel="noopener noreferrer">📖 Compose file reference for Version 3<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://juejin.im/post/5d76e977e51d4557dc774f1c" target="_blank" rel="noopener noreferrer">📝 Docker Compose 编排指南 v3.7（内容比较详实）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://yeasy.gitbooks.io/docker_practice/content/compose/compose_file.html" target="_blank" rel="noopener noreferrer">📝 Docker 实战手册：模版文件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/devops-guidebook/edit/master/docs/deploy/docker/docker-compose.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last Update: ">8/1/2020, 10:27:09 AM</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/devops-guidebook/umi.js"></script>
    <script src="/devops-guidebook/docs__deploy__docker__docker-compose.md.js"></script>
  </body>
</html>
