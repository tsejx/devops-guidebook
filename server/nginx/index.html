<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/devops-guidebook/umi.css" />
    <script>
      window.routerBase = "/devops-guidebook/";
    </script>
    <script>
      //! umi version: 3.2.9
    </script>
    <title>&#x57FA;&#x672C;&#x6982;&#x8981;</title>
  
</head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/server/nginx" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/devops-icon.png&#x27;)" href="/devops-guidebook//">DevOps Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span><a href="/devops-guidebook//linux">Linux</a></span><span><a aria-current="page" class="active" href="/devops-guidebook//server">服务器</a></span><span><a href="/devops-guidebook//deploy">部署</a></span><span><a href="/devops-guidebook//code">代码管理</a></span><span><a href="/devops-guidebook//devops">DevOps</a></span><span><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/devops-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/devops-icon.png&#x27;)" href="/devops-guidebook//"></a><h1>DevOps Guidebook</h1><p>DevOps 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/devops-guidebook//linux">Linux</a></li><li><a aria-current="page" class="active" href="/devops-guidebook//server">服务器</a></li><li><a href="/devops-guidebook//deploy">部署</a></li><li><a href="/devops-guidebook//code">代码管理</a></li><li><a href="/devops-guidebook//devops">DevOps</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/devops-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a aria-current="page" class="active" href="/devops-guidebook//server/nginx">Nginx</a><ul><li><a aria-current="page" class="active" href="/devops-guidebook//server/nginx"><span>基本概要</span></a></li><li><a href="/devops-guidebook//server/nginx/install"><span>安装教程</span></a></li><li><a href="/devops-guidebook//server/nginx/command-line"><span>命令行指令</span></a></li><li><a href="/devops-guidebook//server/nginx/configuration-grammar"><span>配置语法</span></a></li><li><a href="/devops-guidebook//server/nginx/modules"><span>配置模块</span></a></li><li><a href="/devops-guidebook//server/nginx/static-resource-server"><span>静态资源服务器</span></a></li><li><a href="/devops-guidebook//server/nginx/proxy-service"><span>代理服务器</span></a></li><li><a href="/devops-guidebook//server/nginx/load-balance"><span>负载均衡</span></a></li><li><a href="/devops-guidebook//server/nginx/dynamic-cache"><span>动态缓存</span></a></li><li><a href="/devops-guidebook//server/nginx/rewrite"><span>地址重定向</span></a></li><li><a href="/devops-guidebook//server/nginx/https-service"><span>HTTPS 服务</span></a></li><li><a href="/devops-guidebook//server/nginx/log"><span>访问日志</span></a></li><li><a href="/devops-guidebook//server/nginx/architect"><span>架构原理</span></a></li><li><a href="/devops-guidebook//server/nginx/practical-configuration"><span>实用配置</span></a></li><li><a href="/devops-guidebook//server/nginx/best-practice"><span>最佳实践</span></a></li></ul></li><li><a href="/devops-guidebook//server/elk">ELK</a><ul><li><a href="/devops-guidebook//server/elk"><span>ELK</span></a></li><li><a href="/devops-guidebook//server/elk/elasticsearch"><span>Elasticsearch</span></a></li><li><a href="/devops-guidebook//server/elk/logstash"><span>Logstash</span></a></li><li><a href="/devops-guidebook//server/elk/filebeat"><span>Filebeat</span></a></li><li><a href="/devops-guidebook//server/elk/kibana"><span>Kibana</span></a></li></ul></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="工作原理" data-depth="2"><a href="/devops-guidebook//server/nginx#工作原理"><span>工作原理</span></a></li><li title="多进程的工作模式" data-depth="3"><a href="/devops-guidebook//server/nginx#多进程的工作模式"><span>多进程的工作模式</span></a></li><li title="惊群现象" data-depth="3"><a href="/devops-guidebook//server/nginx#惊群现象"><span>惊群现象</span></a></li><li title="中间件架构" data-depth="2"><a href="/devops-guidebook//server/nginx#中间件架构"><span>中间件架构</span></a></li><li title="CPU 亲和" data-depth="3"><a href="/devops-guidebook//server/nginx#cpu-亲和"><span>CPU 亲和</span></a></li><li title="安装目录" data-depth="2"><a href="/devops-guidebook//server/nginx#安装目录"><span>安装目录</span></a></li><li title="编译参数" data-depth="2"><a href="/devops-guidebook//server/nginx#编译参数"><span>编译参数</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="基本概要"><a aria-hidden="true" tabindex="-1" href="/devops-guidebook//server/nginx#基本概要"><span class="icon,icon-link"></span></a>基本概要</h1><p>Nginx 是一个开源且高性能、可靠的 HTTP 中间件，代理服务。Nginx（发音同 engine x）是一个 Web 服务器，也可以用作反向代理，负载平衡器和 HTTP 缓存。该软件由 Igor Sysoev 创建，并于 2004 年首次公开发布。同名公司成立于 2011 年，以提供支持。</p><h2 id="工作原理"><a aria-hidden="true" tabindex="-1" href="/devops-guidebook//server/nginx#工作原理"><span class="icon,icon-link"></span></a>工作原理</h2><p>首先要明白，Nginx 采用的是多进程（单线程） + 多路 IO 复用模型。使用了 I/O 多路复用技术的 Nginx，就成了 <strong>并发事件驱动</strong> 的服务器。</p><h3 id="多进程的工作模式"><a aria-hidden="true" tabindex="-1" href="/devops-guidebook//server/nginx#多进程的工作模式"><span class="icon,icon-link"></span></a>多进程的工作模式</h3><ul><li>Nginx 在启动后，会以 daemon 的方式在后台运行，后台进程包含一个 <code>master</code> 进程和多个相互独立的 <code>worker</code> 进程。工作进程以非特权用户运行。</li><li><code>master</code> 进程主要用来管理 <code>worker</code> 进程，包含：接收来自外界的信号，向各 <code>worker</code> 进程发送信号，监控 <code>worker</code> 进程的运行状态，当 <code>worker</code> 进程退出后（异常情况下），会自动重新启动新的 <code>worker</code> 进程。</li><li><code>worker</code> 进程则是处理基本的网络事件。多个 <code>worker</code> 进程之间是对等的，他们同等竞争来自客户端的请求，各进程互相之间是独立的。一个请求，只可能在一个 <code>worker</code> 进程中处理，一个 <code>worker</code> 进程，不可能处理其它进程的请求。</li></ul><p>工作线程处理实际的请求。Nginx 使用<strong>基于事件</strong>的模型和<strong>依赖操作系统</strong>的机制来有效地在工作进程之间分发请求。</p><blockquote><p>worker 进程数，一般会设置成机器 CPU 核数。因为更多的 worker 数，只会导致进程相互竞争 CPU，从而带来不必要的上下文切换。 使用多进程模式，不仅能提高并法率，而且进程之间相互独立，一个 worker 进程挂了不会影响其他 worker 进程。</p></blockquote><h3 id="惊群现象"><a aria-hidden="true" tabindex="-1" href="/devops-guidebook//server/nginx#惊群现象"><span class="icon,icon-link"></span></a>惊群现象</h3><ul><li>主进程（master 进程）首先通过 <code>socket()</code> 来创建一个 sock 文件描述符用来监听，然后 <code>fork</code> 生成子进程（workers 进程），子进程将继承父进程的 <code>sockfd</code>（socket 文件描述符），之后子进程 <code>accept()</code> 后将创建已连接描述符（connected descriptor）），然后通过已连接描述符来与客户端通信。</li><li>那么，由于所有子进程都继承了父进程的 <code>sockfd</code>，那么当连接进来时，所有子进程都将收到通知并 <strong>争着</strong> 与它建立连接，这就叫 <strong>惊群现象</strong>。大量的进程被激活又挂起，只有一个进程可以 <code>accept()</code> 到这个连接，这当然会消耗系统资源。</li></ul><h2 id="中间件架构"><a aria-hidden="true" tabindex="-1" href="/devops-guidebook//server/nginx#中间件架构"><span class="icon,icon-link"></span></a>中间件架构</h2><p>多个描述符的 I/O 操作都能在一个线程内并发交替地顺序完成，这就教 I/O 多路复用，这里的 <strong>复用</strong> 指的是复用同一个线程。I/O 多路复用的实现方式为：<code>select</code>、<code>poll</code>、<code>epoll</code>。</p><p>Nginx 采用的 I/O 多路复用模型 <code>epoll</code>。</p><h3 id="cpu-亲和"><a aria-hidden="true" tabindex="-1" href="/devops-guidebook//server/nginx#cpu-亲和"><span class="icon,icon-link"></span></a>CPU 亲和</h3><p>CPU 亲和是一种 CPU 核心和 Nginx 工作进程绑定方式，把每个 worker 进程固定在一个 CPU 上执行，减少切换 CPU 的 <code>cache miss</code>，获得更好的性能。</p><p>说白了就是减少 CPU 切换所损耗的性能。</p><h2 id="安装目录"><a aria-hidden="true" tabindex="-1" href="/devops-guidebook//server/nginx#安装目录"><span class="icon,icon-link"></span></a>安装目录</h2><p>列出 Nginx 服务的安装目录：</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function">rpm</span><span class="token plain"> -ql nginx</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><table><thead><tr><th align="left">路径</th><th align="left">类型</th><th align="left">作用</th></tr></thead><tbody><tr><td align="left"><code>/etc/logrotate.d/nginx</code></td><td align="left">配置文件</td><td align="left">nginx 日志轮转，用于 logrotate 服务的日志切割</td></tr><tr><td align="left"><code>/etc/nginx/</code><br/><code>/etc/nginx/conf.d</code><br/><code>/etc/nginx/conf.d/default.conf</code><br/><code>/etc/nginx/nginx.conf</code></td><td align="left">目录、配置文件</td><td align="left">nginx 主配置文件</td></tr><tr><td align="left"><code>/etc/nginx/fastcgi_params</code><br/><code>/etc/nginx/scgi_params</code><br/><code>/etc/nginx/uwsgi_params</code></td><td align="left">配置文件</td><td align="left">cgi 配置相关，fastcgi 配置</td></tr><tr><td align="left"><code>/etc/nginx/koi-utf</code><br/><code>/etc/nginx/koi-win</code><br/><code>/etc/nginx/win-utf</code></td><td align="left">配置文件</td><td align="left">编码映射转化文件</td></tr><tr><td align="left"><code>/etc/nginx/mime.types</code></td><td align="left">配置文件</td><td align="left">设置 HTTP 协议的 Content-Type 与扩展名对应关系</td></tr><tr><td align="left"><code>/etc/sysconfig/nginx</code><br/><code>/etc/sysconfig/nginx-debug</code><br/><code>/usr/lib/systemd/system/nginx-debug.service</code><br/><code>/usr/lib/systemd/system/nginx.service</code></td><td align="left">配置文件</td><td align="left">用于配置出系统守护进程管理器管理方式</td></tr><tr><td align="left"><code>/etc/nginx/modules</code><br/><code>/usr/lib64/nginx/modules</code></td><td align="left">目录</td><td align="left">nginx 模块目录</td></tr><tr><td align="left"><code>/usr/sbin/nginx</code><br/><code>/usr/sbin/nginx-debug</code></td><td align="left">命令</td><td align="left">nginx 服务的可执行程序文件（终端命令）</td></tr><tr><td align="left"><code>/usr/share/doc/nginx-1.12.2</code><br/><code>/usr/share/doc/nginx-1.12.2/COPYRIGHT</code><br/><code>/usr/share/man/man8/nginx.8.gz</code></td><td align="left">文件目录</td><td align="left">nginx 的手册和帮助文件</td></tr><tr><td align="left"><code>/var/cache/nginx</code></td><td align="left">目录</td><td align="left">nginx 的缓存目录</td></tr><tr><td align="left"><code>/var/log/nginx</code></td><td align="left">目录</td><td align="left">nginx 的日志目录</td></tr><tr><td align="left"><code>/usr/share/nginx/html/404.html</code><br/><code>/usr/share/nginx/html/50x.html</code><br/><code>/usr/share/nginx/html/index.html</code></td><td align="left">文件</td><td align="left">nginx 默认的静态资源目录</td></tr></tbody></table><p>Nginx 及其模块的工作方式由配置文件确定。 默认情况下，配置文件名为 <code>nginx.conf</code>，放在 <code>/etc/nginx/conf.d</code>、<code>/usr/local/nginx/conf</code> 或者 <code>/usr/local/etc/nginx</code> 文件夹中。</p><h2 id="编译参数"><a aria-hidden="true" tabindex="-1" href="/devops-guidebook//server/nginx#编译参数"><span class="icon,icon-link"></span></a>编译参数</h2><p>列出编译参数的命令：</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">nginx -V</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><table><thead><tr><th align="left">路径</th><th align="left">类型</th></tr></thead><tbody><tr><td align="left"><code>--prefix=/etc/nginx</code><br/><code>--sbin-path=/usr/sbin/nginx</code><br/><code>--modules-path=/usr/lib64/nginx/modules</code><br/><code>--conf-path=/etc/nginx/nginx.conf</code><br/><code>--error-log-path=/var/log/nginx/error.log</code><br/><code>--http-log-path=/var/log/nginx/access.log</code><br/><code>--pid-path=/var/run/nginx.pid</code><br/><code>--lock-path=/var/run/nginx.lock</code><br/></td><td align="left">安装目录</td></tr><tr><td align="left"><code>--http-client-body-temp-path=/var/cache/nginx/client_temp</code><br/><code>--http-proxy-temp-path=/var/cache/nginx/proxy_temp</code><br/><code>--http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp</code><br/><code>--http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp</code><br/><code>--http-scgi-temp-path=/var/cache/nginx/scgi_temp</code></td><td align="left">执行对应模块时，Nginx 所保留的临时性文件</td></tr><tr><td align="left"><code>--user=nginx --group=nginx</code></td><td align="left">设定 Nginx 进程启动的用户和组用户</td></tr><tr><td align="left"><code>--with-cc-opt=parameters</code></td><td align="left">设置额外的参数将添加到 CFLAGS 变量</td></tr><tr><td align="left"><code>--with-ld-opt=parameters</code></td><td align="left">设置附加的参数，连接系统库</td></tr></tbody></table><hr/><p><strong>参考资料：</strong></p><ul><li><a target="_blank" rel="noopener noreferrer" href="https://www.cnblogs.com/yblackd/p/12194143.html">📝 Nginx 工作原理（Master+Worker）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://mp.weixin.qq.com/s/ZaKUtj7NgRSI72m5S4quDg">📝 Nginx 最全操作总结<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/devops-guidebook/edit/master/docs/server/nginx/index.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last update: ">9/9/2021 06:19:33</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/devops-guidebook/umi.js"></script>
    <script src="/devops-guidebook/docs__server__nginx__index.md.js"></script>
  </body>
</html>
