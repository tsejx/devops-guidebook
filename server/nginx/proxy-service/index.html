<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/devops-guidebook/umi.css" />
    <script>
      window.routerBase = "/devops-guidebook/";
    </script>
    <script>
      //! umi version: 3.2.9
    </script>
    <title>&#x4EE3;&#x7406;&#x670D;&#x52A1;&#x5668;</title>
  
</head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/devops-icon.png&#x27;)" href="/devops-guidebook//">DevOps Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a href="/devops-guidebook//linux">Linux</a><a aria-current="page" class="active" href="/devops-guidebook//server">服务器</a><a href="/devops-guidebook//data-base">数据库</a><a href="/devops-guidebook//deploy">部署</a><a href="/devops-guidebook//code">代码管理</a><a href="/devops-guidebook//devops">DevOps</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/devops-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/devops-icon.png&#x27;)" href="/devops-guidebook//"></a><h1>DevOps Guidebook</h1><p>DevOps 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/devops-guidebook//linux">Linux</a></li><li><a aria-current="page" class="active" href="/devops-guidebook//server">服务器</a></li><li><a href="/devops-guidebook//data-base">数据库</a></li><li><a href="/devops-guidebook//deploy">部署</a></li><li><a href="/devops-guidebook//code">代码管理</a></li><li><a href="/devops-guidebook//devops">DevOps</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/devops-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a aria-current="page" class="active" href="/devops-guidebook//server/nginx">Nginx</a><ul><li><a href="/devops-guidebook//server/nginx"><span>基本概要</span></a></li><li><a href="/devops-guidebook//server/nginx/command-line"><span>命令行指令</span></a></li><li><a href="/devops-guidebook//server/nginx/configuration-grammar"><span>配置语法</span></a></li><li><a href="/devops-guidebook//server/nginx/static-resource-server"><span>静态资源服务器</span></a></li><li><a aria-current="page" class="active" href="/devops-guidebook//server/nginx/proxy-service"><span>代理服务器</span></a></li><li><a href="/devops-guidebook//server/nginx/load-balance"><span>负载均衡</span></a></li><li><a href="/devops-guidebook//server/nginx/dynamic-cache"><span>动态缓存</span></a></li><li><a href="/devops-guidebook//server/nginx/rewrite"><span>地址重定向</span></a></li><li><a href="/devops-guidebook//server/nginx/https-service"><span>HTTPS 服务</span></a></li><li><a href="/devops-guidebook//server/nginx/practical-configuration"><span>实用配置</span></a></li></ul></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"><li title="代理区别" data-depth="2" class=""><a href="/devops-guidebook//server/nginx/proxy-service#代理区别"><span>代理区别</span></a></li><li title="正向代理" data-depth="3" class=""><a href="/devops-guidebook//server/nginx/proxy-service#正向代理"><span>正向代理</span></a></li><li title="反向代理" data-depth="3" class=""><a href="/devops-guidebook//server/nginx/proxy-service#反向代理"><span>反向代理</span></a></li><li title="基本配置" data-depth="2" class=""><a href="/devops-guidebook//server/nginx/proxy-service#基本配置"><span>基本配置</span></a></li><li title="通用配置" data-depth="2" class=""><a href="/devops-guidebook//server/nginx/proxy-service#通用配置"><span>通用配置</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="代理服务器"><a aria-hidden="true" href="#代理服务器"><span class="icon icon-link"></span></a>代理服务器</h1><p>Nginx 的一个常见应用是将其设置为代理服务器（Proxy Server），即接受客户端的请求并将其转发给真正的服务器，再接受真正的服务器发来的响应，将它们发送到客户端。</p><h2 id="代理区别"><a aria-hidden="true" href="#代理区别"><span class="icon icon-link"></span></a>代理区别</h2><ul><li>正向代理的对象是客户端</li><li>反向代理代理的是服务器</li></ul><h3 id="正向代理"><a aria-hidden="true" href="#正向代理"><span class="icon icon-link"></span></a>正向代理</h3><p>反向代理不好理解，正向代理大家总有用过，翻墙工具其实就是一个正向代理工具。它会把访问墙外服务器 Server 的网页请求，代理到一个可以访问该网站的代理服务器 Proxy，这个代理服务器 Proxy 把墙外服务器 Server 上的网页内容获取，再转发给客户。</p><p>概括说：就是客户端和代理服务器可以直接互相访问，属于一个 LAN（局域网）；代理对用户是非透明的，即用户需要自己操作或者感知得到自己的请求被发送到代理服务器；代理服务器通过代理用户端的请求来向域外服务器请求响应内容。</p><h3 id="反向代理"><a aria-hidden="true" href="#反向代理"><span class="icon icon-link"></span></a>反向代理</h3><p>在反向代理中（事实上，这种情况基本发生在所有的大型网站的页面请求中），客户端发送的请求，想要访问 Server 服务器上的内容。但将被发送到一个代理服务器 Proxy，这个代理服务器将把请求代理到和自己属于同一个 LAN 下的内部服务器上，而用户真正想获得的内容就储存在这些内部服务器上。看到区别了吗，这里 Proxy 服务器代理的并不是客户，而是服务器，即向外部客户端提供了一个统一的代理入口，客户端的请求，都先经过这个 proxy 服务器，至于在内网真正访问哪台服务器内容，由这个 Proxy 去控制。一般代理是指代理客户端，而这里代理的对象是服务器，这就是 <strong>反向</strong> 这个词的意思。Nginx 就是来充当这个 Proxy 的作用。</p><p>概括说：就是代理服务器和真正 Server 服务器可以直接互相访问，属于一个 LAN（服务器内网）；代理对用户是透明的，即无感知。不论加不加这个反向代理，用户都是通过相同的请求进行的，且不需要任何额外的操作；代理服务器通过代理内部服务器接受域外客户端的请求，并将请求发送到对应的内部服务器上。</p><p>使用反向代理最主要有两个原因：</p><ol><li>安全及权限。可以看出，使用反向代理后，用户端将无法直接通过请求访问真正的内容服务器，而必须首先通过 Nginx。可以通过在 Nginx 层上将危险或者没有权限的请求内容过滤掉，从而保证了服务器的安全。</li><li>负载均衡。例如一个网站的内容被部署在若干台服务器上，可以把这些机子看成一个集群，那么 Nginx 可以将接收到的客户端请求“均匀地”分配到这个集群中所有的服务器上（内部模块提供了多种负载均衡算法），从而实现服务器压力的负载均衡。此外，nginx 还带有健康检查功能（服务器心跳检查），会定期轮询向集群里的所有服务器发送健康检查请求，来检查集群中是否有服务器处于异常状态，一旦发现某台服务器异常，那么在以后代理进来的客户端请求都不会被发送到该服务器上（直到后面的健康检查发现该服务器恢复正常），从而保证客户端访问的稳定性。</li></ol><h2 id="基本配置"><a aria-hidden="true" href="#基本配置"><span class="icon icon-link"></span></a>基本配置</h2><p>首先，向 Nginx 的配置文件中添加一个 <code>server</code> 块来定义代理服务器：</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="server {
    listen 8080;
    root /data/example;

    location / {}
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">server</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">listen</span><span class="token plain"> </span><span class="token number">8080</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">root</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain">data</span><span class="token operator">/</span><span class="token plain">example</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">location</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>此服务器侦听端口 8080，并将所有请求映射到本地文件系统上的 <code>/data/example</code> 目录。 创建此目录并将 <code>index.html</code> 放入其中。 注意，<code>root</code> 指令放在 <code>server</code> 上下文中，这样当 <code>location</code> 块中不含 <code>root</code> 指令时将使用所属 <code>server</code> 的 <code>root</code> 指令。</p><p>接下来，使用上一节中的服务器配置，并将其修改为代理服务器配置。 在第一个位置块中，加上 <code>proxy_pass</code> 指令：</p><div class="__dumi-default-code-block"><pre class="prism-code language-ngix"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="server {
  location / {
    # proxy_pass指令的参数为：协议+主机名+端口号
    proxy_pass http://localhost:8080;
  }

  location /images/ {
    root /data;
  }
}
" data-status="copy"></button><div class="token-line"><span class="token plain">server {</span></div><div class="token-line"><span class="token plain">  location / {</span></div><div class="token-line"><span class="token plain">    # proxy_pass指令的参数为：协议+主机名+端口号</span></div><div class="token-line"><span class="token plain">    proxy_pass http://localhost:8080;</span></div><div class="token-line"><span class="token plain">  }</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  location /images/ {</span></div><div class="token-line"><span class="token plain">    root /data;</span></div><div class="token-line"><span class="token plain">  }</span></div><div class="token-line"><span class="token plain">}</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>修改第二个 匹配 <code>/images/</code> 前缀的 <code>location</code> 块，使其与请求图像文件的扩展名相匹配：</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="location ~ \.(gif|jpg|png)$ {
    root /data/images;
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">location</span><span class="token plain"> </span><span class="token operator">~</span><span class="token plain"> \</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token plain">gif</span><span class="token operator">|</span><span class="token plain">jpg</span><span class="token operator">|</span><span class="token plain">png</span><span class="token punctuation">)</span><span class="token plain">$ </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">root</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain">data</span><span class="token operator">/</span><span class="token plain">images</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>该参数是一个正则表达式，匹配以 <code>.gif</code>、<code>.jpg</code> 或 <code>.png</code>结尾的所有 URI。 正则表达式应该以 <code>~</code> 开头。 相应的请求将映射到 <code>/data/images</code> 目录。</p><p>当 Nginx 选择一个 <code>location</code> 块来处理请求时，它首先检查指定 <code>location</code> 块的前缀，记住具有最长前缀的 <code>location</code> 块，然后检查正则表达式。 如果与正则表达式匹配， Nginx 选择此 <code>location</code> 块，否则，选择先前记住的 <code>location</code> 块。</p><p>代理服务器的最终配置如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="server {
    location / {
        proxy_pass http://localhost:8080/;
    }

    location ~ \.(gif|jpg|png)$ {
        root /data/images;
    }
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">server</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">location</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">proxy_pass</span><span class="token plain"> </span><span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token plain">localhost</span><span class="token punctuation">:</span><span class="token number">8080</span><span class="token operator">/</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">location</span><span class="token plain"> </span><span class="token operator">~</span><span class="token plain"> \</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token plain">gif</span><span class="token operator">|</span><span class="token plain">jpg</span><span class="token operator">|</span><span class="token plain">png</span><span class="token punctuation">)</span><span class="token plain">$ </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">root</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain">data</span><span class="token operator">/</span><span class="token plain">images</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>此服务器将过滤以 <code>.gif</code>、<code>.jpg</code> 或 <code>.png</code> 结尾的请求，并将它们映射到 <code>/data/images</code> 目录（通过向 <code>root</code> 指令的参数添加请求的 <code>URI</code>），并将所有其他请求发送给上面配置的代理服务器。</p><p>这样，图片和其他请求就可以使用不同的服务器来处理。</p><h2 id="通用配置"><a aria-hidden="true" href="#通用配置"><span class="icon icon-link"></span></a>通用配置</h2><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="server {
    # 监听 80 端口
    listen 80;
    # 转发至的目标服务器，如果是本地服务器地址则是 localhost
    server_name target.domain.com;

    # charset koi8-r;
    access_log /var/log/nginx/test_proxy.access.log main;

    location / {
        # HTTP 版本
        proxy_http_version 1.1;

        # 代理服务器指向的真正服务器地址
        proxy_pass http://127.0.0.1:8080

        # 跳转重定向配置
        proxy_redirect default;

        # 头信息配置
        # 请求 Host 传给真正服务器
        proxy_set_header    Host          $http_host;
        # 请求 IP 传给真正服务器
        proxy_set_header    X-Real-IP     $remote_addr;
        # 请求协议传给真正服务器
        proxy_set_header    X-Scheme          $scheme;
        proxy_set_header    X-Forward-For     $proxy_add_x_forwarded_for;

        # 超时配置
        proxy_connect_timeout 30;
        proxy_send_timeout 60;
        proxy_read_timeout 60;

        # 缓冲区配置
        # 被代理服务器数据和客户端请求异步
        proxy_buffering on;
        # 特殊 Buffer 大小
        proxy_buffer_size 32k;
        # 代理服务器可占用 Buffer 个数和每个 Buffer 大小
        proxy_buffers 4 128k;
        proxy_busy_buffers_size 256k;
        # 临时文件目录及层级
        proxy_temp_path /usr/local/nginx/proxy_temp 1 2;
        # 临时文件总大小
        proxy_max_temp_file_size 256k;

        # 路径重写
        # 在使用 Nginx 做反向代理的时候，需要匹配到跨域的接口再作转发，为了方便匹配之后、转发之前把添加的那段去掉，因此需要 rewrite
        # rewrite /api/(.*) /$1 break;
    }
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">server</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment"># 监听 80 端口</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">listen</span><span class="token plain"> </span><span class="token number">80</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment"># 转发至的目标服务器，如果是本地服务器地址则是 localhost</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">server_name</span><span class="token plain"> target</span><span class="token punctuation">.</span><span class="token plain">domain</span><span class="token punctuation">.</span><span class="token plain">com</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment"># charset koi8-r;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">access_log</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain">var</span><span class="token operator">/</span><span class="token plain">log</span><span class="token operator">/</span><span class="token plain">nginx</span><span class="token operator">/</span><span class="token plain">test_proxy</span><span class="token punctuation">.</span><span class="token plain">access</span><span class="token punctuation">.</span><span class="token plain">log main</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">location</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment"># HTTP 版本</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">proxy_http_version</span><span class="token plain"> </span><span class="token number">1.1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment"># 代理服务器指向的真正服务器地址</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">proxy_pass</span><span class="token plain"> </span><span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8080</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment"># 跳转重定向配置</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">proxy_redirect</span><span class="token plain"> default</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment"># 头信息配置</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment"># 请求 Host 传给真正服务器</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">proxy_set_header</span><span class="token plain">    Host          </span><span class="token variable">$http_host</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment"># 请求 IP 传给真正服务器</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">proxy_set_header</span><span class="token plain">    X</span><span class="token operator">-</span><span class="token plain">Real</span><span class="token operator">-</span><span class="token plain">IP     </span><span class="token variable">$remote_addr</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment"># 请求协议传给真正服务器</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">proxy_set_header</span><span class="token plain">    X</span><span class="token operator">-</span><span class="token plain">Scheme          </span><span class="token variable">$scheme</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">proxy_set_header</span><span class="token plain">    X</span><span class="token operator">-</span><span class="token plain">Forward</span><span class="token operator">-</span><span class="token plain">For     </span><span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment"># 超时配置</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">proxy_connect_timeout</span><span class="token plain"> </span><span class="token number">30</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">proxy_send_timeout</span><span class="token plain"> </span><span class="token number">60</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">proxy_read_timeout</span><span class="token plain"> </span><span class="token number">60</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment"># 缓冲区配置</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment"># 被代理服务器数据和客户端请求异步</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">proxy_buffering</span><span class="token plain"> on</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment"># 特殊 Buffer 大小</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">proxy_buffer_size</span><span class="token plain"> </span><span class="token number">32</span><span class="token plain">k</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment"># 代理服务器可占用 Buffer 个数和每个 Buffer 大小</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">proxy_buffers</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain"> </span><span class="token number">128</span><span class="token plain">k</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">proxy_busy_buffers_size</span><span class="token plain"> </span><span class="token number">256</span><span class="token plain">k</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment"># 临时文件目录及层级</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">proxy_temp_path</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain">usr</span><span class="token operator">/</span><span class="token plain">local</span><span class="token operator">/</span><span class="token plain">nginx</span><span class="token operator">/</span><span class="token plain">proxy_temp </span><span class="token number">1</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment"># 临时文件总大小</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">proxy_max_temp_file_size</span><span class="token plain"> </span><span class="token number">256</span><span class="token plain">k</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment"># 路径重写</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment"># 在使用 Nginx 做反向代理的时候，需要匹配到跨域的接口再作转发，为了方便匹配之后、转发之前把添加的那段去掉，因此需要 rewrite</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment"># rewrite /api/(.*) /$1 break;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><hr/><p><strong>参考资料：</strong></p><ul><li><a href="https://www.cnblogs.com/yyxianren/p/10831673.html" target="_blank" rel="noopener noreferrer">📝 Nginx 反向代理之 proxy_buffering<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/devops-guidebook/edit/master/docs/server/nginx/proxy-service.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last Update: ">8/20/2020, 1:31:11 PM</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/devops-guidebook/umi.js"></script>
    <script src="/devops-guidebook/docs__server__nginx__proxy-service.md.js"></script>
  </body>
</html>
